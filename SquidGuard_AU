#!/bin/bash

##############################
#  SquidGuard Update Script  #
##############################

# Variables :
URL="ftp://ftp.univ-tlse1.fr/blacklist"
DATABASE="/etc/squidGuard/db/blacklists"
BASES_tmp=`cat /etc/squidGuard/squidGuard.conf | grep dest | awk '{print $2}' | sort -d`
BASES=( $BASES_tmp )

# Core
for base in "${BASES[@]}"
do
   echo "Récupération de(s) base(s) ${base}..."
   # Récupération de l'archive :
   cd /tmp
   wget --continue --quiet --timeout=30 ${URL}/${base}.tar.gz

   # Décompression de l'archive :
   tar -xvzf ${base}.tar.gz -C ${DATABASE}

   # Suppression de l'archive temporaire :
   rm /tmp/${base}.tar.gz

done

# Génération de la base :
echo "Génération de(s) base(s), patientez svp..."
/usr/bin/squidGuard -P -C all

# Attribution des droits sur les bases :
echo "Attribution des droits..."
chown -R squid:squid ${DATABASE}/*

# Reloading Squid Conf
echo "Rechargement de Squid, patientez svp..."
/etc/init.d/squid reload && sleep 3

exit 0
